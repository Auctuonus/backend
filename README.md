# Auctionus - Архитектура системы

## Обзор

Auctionus - это система для проведения многораундовых онлайн-аукционов. Лоты представлены в виде строк данных.

## Что мы нашли в аналоге Auctionus - Telegram Gift Auctions

- Аукционы проводятся в несколько раундов.
- В каждом раунде может разыгрываться несколько предметов.
- Антиснайпинг - при ставке близкой к концу аукциона, аукцион продлевается.
- Можно повысить свою ставку не зависимо от твоего места и не дожидаясь каких либо условий.
- При окончании раунда:
  - Предметы этого раунда отдаются за самые большие ставки (Предмет ID-1 отдается топ-1 ставке, предмет ID-2 отдается топ-2 ставке и тд)
  - Когда предметы заканчиваются ставки переносятся в следующий раунд.
  - Если это последний раунд, ставки, не выигравшие предметы, считаются проигравшими и возвращаются владельцам.

## System Diagram
![System Diagram](./docs/SystemDiagram.png)

## Технологический стек

- **Framework**: NestJS (Требование)
- **Authentication**: JWT + Telegram / Password
- **Database**: MongoDB - Mongoose (Требование)
- **Cache/Locks**: Redis
  - Нужен простой кэш по ключу
  - Нужна возможность создавать lock-и
- **Message Queue**: RabbitMQ
  - Нам нужна возможность отправлять отложенные сообщения для начала обработки аукциона к определенному времени


## Как работает система?

- Предметы и аукционы создаются в базе заблаговременно скриптами / руками. При создании также прокидывается отложенное сообщение в RabbitMQ с временем окончания аукциона.
- Пользователь авторизуется через Telegram Mini Apps (InitData) и получают уже авторизационный токен нашей системы.
- Пользователь получает список аукционов и выбирает интересующий его.
- Пользователи ставят ставки до окончания аукциона с блокировкой аукциона.
- При окончании раунда сообщение попадает в очередь, которую слушает раннер.
- Ранер получает сообщение, фиксирует окончание раунда аукциона и начинает поэтапную обработку раунда с разделением этапов по доменам / данным:
  - DETERMINE_WINNERS
  - TRANSFER_ITEMS
  - PROCESS_PAYMENTS
  - REFUND_LOSERS
  - FINALIZE
- Поэтапная обработка сделана для уменьшения времени локов и транзакций.


## Проверка системы:

- Написаны тесты:
  - интеграционные для проверки валидности логики
  - e2e для проверки совместимости всех компонентов системы
  - 